#!/bin/bash

# === –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ===
MODEL="${1:-1}"    # –ü–∞—Ä–∞–º–µ—Ç—Ä –º–æ–¥–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
RECLONE="${2:-n}"  # –ù—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ—Å–∫–∞—á–∏–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é n)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è MODEL
if [[ "$MODEL" != "1" && "$MODEL" != "2" && "$MODEL" != "3" ]]; then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ model: $MODEL. –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: 1, 2, 3"
    exit 1
fi

echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: model=$MODEL, reclone=$RECLONE"

# === –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ===
sudo apt update && sudo apt install -y python3 python3-venv python3-pip curl screen git gnupg

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Yarn
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
sudo apt update && sudo apt install -y yarn

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
curl -sSL https://raw.githubusercontent.com/zunxbt/installation/main/node.sh | bash

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö screen-—Å–µ—Å—Å–∏–π –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 3000
killall screen 2>/dev/null || true
lsof -ti:3000 | xargs kill -9 2>/dev/null || true

# === –†–∞–±–æ—Ç–∞ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º ===
if [ "$RECLONE" == "y" ]; then
    echo "üì¶ –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –∏ –∫–ª–æ–Ω–∏—Ä—É—é –∑–∞–Ω–æ–≤–æ..."
    rm -rf rl-swarm
    git clone https://github.com/anfisatarasova/gg.git rl-swarm
    cd rl-swarm
else
    if [ ! -d "rl-swarm" ]; then
        echo "üì¶ –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∫–ª–æ–Ω–∏—Ä—É—é..."
        git clone https://github.com/anfisatarasova/gg.git rl-swarm
    fi
    cd rl-swarm
    echo "üîÑ –û–±–Ω–æ–≤–ª—è—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ git pull..."
    git pull
fi

# === –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ ===
TARGET_CONFIG="hivemind_exp/configs/gpu/grpo-qwen-2.5-1.5b-deepseek-r1.yaml"

case "$MODEL" in
    1) CFG_URL="https://raw.githubusercontent.com/anfisatarasova/cfg/refs/heads/main/cfg-1" ;;
    2) CFG_URL="https://raw.githubusercontent.com/anfisatarasova/cfg/refs/heads/main/cfg-2" ;;
    3) CFG_URL="https://raw.githubusercontent.com/anfisatarasova/cfg/refs/heads/main/cfg-3" ;;
esac

echo "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞—é –∫–æ–Ω—Ñ–∏–≥ –º–æ–¥–µ–ª–∏ $MODEL —Å $CFG_URL"
curl -fsSL "$CFG_URL" -o "$TARGET_CONFIG"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ –º–æ–¥–µ–ª–∏ $MODEL —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ $TARGET_CONFIG"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥–∞. –ü—Ä–æ–≤–µ—Ä—å —Å—Å—ã–ª–∫—É –∏–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."
    exit 1
fi

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞ ===
ARCHIVE_FOUND=$(find /workspace -maxdepth 1 -type f -name '[0-9]*.tar' | head -n 1)
if [ -n "$ARCHIVE_FOUND" ]; then
    echo "üì¶ –ù–∞–π–¥–µ–Ω –∞—Ä—Ö–∏–≤ $ARCHIVE_FOUND. –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞—é..."
    tar -xvf "$ARCHIVE_FOUND" -C /workspace
    echo "‚úÖ –ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω!"
else
    echo "üì≠ –ê—Ä—Ö–∏–≤–æ–≤ –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
fi

# === –ó–∞–ø—É—Å–∫ RL Swarm –≤ screen-—Å–µ—Å—Å–∏–∏ === 
screen -dmS gensyn bash -c 'cd /workspace/rl-swarm && python3 -m venv .venv && source .venv/bin/activate && trap "" SIGINT && ./run_rl_swarm.sh; exec bash -i' &
disown

echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. RL Swarm –∑–∞–ø—É—â–µ–Ω –≤ screen-—Å–µ—Å—Å–∏–∏ 'gensyn'"
